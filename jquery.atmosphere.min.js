/*
 * Copyright 2014 Jeanfrancois Arcand
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * Atmosphere.js
 * https://github.com/Atmosphere/atmosphere-javascript
 * 
 * Requires 
 * - jQuery 2.0.3 http://jquery.com/
 * 
 * API reference
 * https://github.com/Atmosphere/atmosphere/wiki/jQuery.atmosphere.js-API
 * 
 * Highly inspired by 
 * - Portal by Donghwan Kim http://flowersinthesand.github.io/portal/
 */
(function(e){"function"===typeof define&&define.amd?define(["jquery"],e):e(jQuery)})(function(e){e(window).bind("unload.atmosphere",function(){e.atmosphere.unsubscribe()});e(window).bind("offline",function(){e.atmosphere.unsubscribe()});e(window).keypress(function(e){27===e.keyCode&&e.preventDefault()});var fa=function(e){for(var l,h=/^(.*?):[ \t]*([^\r\n]*)\r?$/mg,r={};l=h.exec(e);)r[l[1]]=l[2];return r};e.atmosphere={version:"2.2.1-jquery",uuid:0,requests:[],callbacks:[],onError:function(e){},onClose:function(e){},
onOpen:function(e){},onMessage:function(e){},onReconnect:function(e,l){},onMessagePublished:function(e){},onTransportFailure:function(e,l){},onLocalMessage:function(e){},onClientTimeout:function(e){},onFailureToReconnect:function(e,l){},WebsocketApiAdapter:function(e){var l,h;e.onMessage=function(e){h.onmessage({data:e.responseBody})};e.onOpen=function(e){h.onopen(e)};h={send:function(e){l.push(e)},onmessage:function(e){},onopen:function(e){},onclose:function(e){},onerror:function(e){}};l=new $.atmosphere.subscribe(e);
return h},AtmosphereRequest:function(k){function l(c){q();aa=!0;G=!1;A=0;C=L=y=p=null;d=e.extend(d,c);d.mrequest=d.reconnect;d.reconnect||(d.reconnect=!0)}function h(){if(d.shared){w=r(d);if(null!=w&&("debug"===d.logLevel&&e.atmosphere.debug("Storage service available. All communication will be local"),w.open(d)))return;"debug"===d.logLevel&&e.atmosphere.debug("No Storage service available.");w=null}d.firstMessage=0==e.atmosphere.uuid?!0:!1;d.isOpen=!1;d.ctime=e.now();0===d.uuid&&(d.uuid=e.atmosphere.uuid);
d.closedByClientTimeout=!1;"websocket"!==d.transport&&"sse"!==d.transport?W(d):"websocket"===d.transport?null!=d.webSocketImpl||window.WebSocket||window.MozWebSocket?m(!1):M("Websocket is not supported, using request.fallbackTransport ("+d.fallbackTransport+")"):"sse"===d.transport&&(window.EventSource?t(!1):M("Server Side Events(SSE) is not supported, using request.fallbackTransport ("+d.fallbackTransport+")"))}function r(c){function a(a){a=e.parseJSON(a);var g=a.data;if("c"===a.target)switch(a.type){case "open":n("opening",
"local",d);break;case "close":ba||(ba=!0,"aborted"===g.reason?O():g.heir===H?h():setTimeout(function(){h()},100));break;case "message":I(g,"messageReceived",200,c.transport);break;case "localMessage":ga(g)}}function f(){var a=(new RegExp("(?:^|; )("+encodeURIComponent(s)+")=([^;]*)")).exec(document.cookie);if(a)return e.parseJSON(decodeURIComponent(a[2]))}var g,D,ba,s="atmosphere-"+c.url,k={storage:function(){if(e.atmosphere.supportStorage()){var d=window.localStorage,g=function(a){return e.parseJSON(d.getItem(s+
"-"+a))},f=function(a,c){d.setItem(s+"-"+a,e.stringifyJSON(c))};return{init:function(){f("children",g("children").concat([H]));e(window).on("storage.socket",function(c){c=c.originalEvent;c.key===s&&c.newValue&&a(c.newValue)});return g("opened")},signal:function(a,c){d.setItem(s,e.stringifyJSON({target:"p",type:a,data:c}))},close:function(){var a,d=g("children");e(window).off("storage.socket");d&&(a=e.inArray(c.id,d),-1<a&&(d.splice(a,1),f("children",d)))}}}},windowref:function(){var c=window.open("",
s.replace(/\W/g,""));if(c&&!c.closed&&c.callbacks)return{init:function(){c.callbacks.push(a);c.children.push(H);return c.opened},signal:function(a,d){!c.closed&&c.fire&&c.fire(e.stringifyJSON({target:"p",type:a,data:d}))},close:function(){if(!ba){var d=c.callbacks,g=e.inArray(a,d);-1<g&&d.splice(g,1);d=c.children;g=e.inArray(H,d);-1<g&&d.splice(g,1)}}}}};if((g=f())&&!(1E3<e.now()-g.ts)&&(D=k.storage()||k.windowref()))return{open:function(){var d;X=setInterval(function(){var c=g;(g=f())&&c.ts!==g.ts||
a(e.stringifyJSON({target:"c",type:"close",data:{reason:"error",heir:c.heir}}))},1E3);(d=D.init())&&setTimeout(function(){n("opening","local",c)},50);return d},send:function(a){D.signal("send",a)},localSend:function(a){D.signal("localSend",e.stringifyJSON({id:H,event:a}))},close:function(){G||(clearInterval(X),D.signal("close"),D.close())}}}function P(){function c(a){a=e.parseJSON(a);var c=a.data;if("p"===a.target)switch(a.type){case "send":Q(c);break;case "localSend":ga(c);break;case "close":O()}}
function a(){document.cookie=ca+"="+encodeURIComponent(e.stringifyJSON({ts:e.now()+1,heir:(f.get("children")||[])[0]}))+"; path=/"}var f,g="atmosphere-"+d.url,D={storage:function(){if(e.atmosphere.supportStorage()){var a=window.localStorage;return{init:function(){e(window).on("storage.socket",function(a){a=a.originalEvent;a.key===g&&a.newValue&&c(a.newValue)})},signal:function(c,d){a.setItem(g,e.stringifyJSON({target:"c",type:c,data:d}))},get:function(c){return e.parseJSON(a.getItem(g+"-"+c))},set:function(c,
d){a.setItem(g+"-"+c,e.stringifyJSON(d))},close:function(){e(window).off("storage.socket");a.removeItem(g);a.removeItem(g+"-opened");a.removeItem(g+"-children")}}}},windowref:function(){var a=g.replace(/\W/g,""),d=(e('iframe[name="'+a+'"]')[0]||e('<iframe name="'+a+'" />').hide().appendTo("body")[0]).contentWindow;return{init:function(){d.callbacks=[c];d.fire=function(a){var c;for(c=0;c<d.callbacks.length;c++)d.callbacks[c](a)}},signal:function(a,c){!d.closed&&d.fire&&d.fire(e.stringifyJSON({target:"c",
type:a,data:c}))},get:function(a){return d.closed?null:d[a]},set:function(a,c){d.closed||(d[a]=c)},close:function(){}}}};R=function(a){f.signal("message",a)};f=D.storage()||D.windowref();f.init();"debug"===d.logLevel&&e.atmosphere.debug("Installed StorageService "+f);f.set("children",[]);null==f.get("opened")||f.get("opened")||f.set("opened",!1);ca=encodeURIComponent(g);a();X=setInterval(a,1E3);E=f}function n(c,a,e){d.shared&&"local"!==a&&P();null!=E&&E.set("opened",!0);e.close=function(){O()};0<
A&&"re-connecting"===c?(e.isReopen=!0,qa(f)):null==f.error&&(f.request=e,e=f.state,f.state=c,c=f.transport,f.transport=a,a=f.responseBody,x(),f.responseBody=a,f.state=e,f.transport=c)}function ha(c){c.transport="jsonp";var a=d;null!=c&&"undefined"!==typeof c&&(a=c);c=a.url;null!=a.dispatchUrl&&(c+=a.dispatchUrl);var z=a.data;a.attachHeadersAsQueryString&&(c=K(a),""!==z&&(c+="&X-Atmosphere-Post-Body="+encodeURIComponent(z)),z="");u=e.ajax({url:c,type:a.method,dataType:"jsonp",error:function(c,d,e){f.error=
!0;a.openId&&clearTimeout(a.openId);a.heartbeatTimer&&clearTimeout(a.heartbeatTimer);a.reconnect&&A++<a.maxReconnectOnClose?(n("re-connecting",a.transport,a),B(u,a,a.reconnectInterval),a.openId=setTimeout(function(){S(a)},a.reconnectInterval+1E3)):v(c.status,e)},jsonp:"jsonpTransport",success:function(c){if(a.reconnect)if(-1===a.maxRequest||a.requestCount++<a.maxRequest){Y(u,a);a.executeCallbackBeforeReconnect||B(u,a,a.pollingInterval);c=c.message;if(null!=c&&"string"!==typeof c)try{c=e.stringifyJSON(c)}catch(z){}F(c,
a,f)||I(f.responseBody,"messageReceived",200,a.transport);a.executeCallbackBeforeReconnect&&B(u,a,a.pollingInterval)}else e.atmosphere.log(d.logLevel,["JSONP reconnect maximum try reached "+d.requestCount]),v(0,"maxRequest reached")},data:a.data,beforeSend:function(c){da(c,a,!1)}})}function ra(c){var a=d;null!=c&&"undefined"!==typeof c&&(a=c);c=a.url;null!=a.dispatchUrl&&(c+=a.dispatchUrl);var z=a.data;a.attachHeadersAsQueryString&&(c=K(a),""!==z&&(c+="&X-Atmosphere-Post-Body="+encodeURIComponent(z)),
z="");u=e.ajax({url:c,type:a.method,error:function(c,d,e){f.error=!0;300>c.status?B(u,a):v(c.status,e)},success:function(c,z,h){a.reconnect&&(-1===a.maxRequest||a.requestCount++<a.maxRequest?(a.executeCallbackBeforeReconnect||B(u,a,a.pollingInterval),F(c,a,f)||I(f.responseBody,"messageReceived",200,a.transport),a.executeCallbackBeforeReconnect&&B(u,a,a.pollingInterval)):(e.atmosphere.log(d.logLevel,["AJAX reconnect maximum try reached "+d.requestCount]),v(0,"maxRequest reached")))},beforeSend:function(c){da(c,
a,!1)},crossDomain:a.enableXDR,async:"undefined"!==typeof a.async?a.async:!0})}function sa(c){return null!=d.webSocketImpl?d.webSocketImpl:window.WebSocket?new WebSocket(c):new MozWebSocket(c)}function N(){var c=K(d);return decodeURI(e('<a href="'+c+'"/>')[0].href.replace(/^http/,"ws"))}function t(c){f.transport="sse";var a=K(d);"debug"===d.logLevel&&(e.atmosphere.debug("Invoking executeSSE"),e.atmosphere.debug("Using URL: "+a));if(d.enableProtocol&&c){var z=e.now()-d.ctime;d.lastTimestamp=Number(d.stime)+
Number(z)}if(c&&!d.reconnect)null!=y&&q();else{try{y=new EventSource(a,{withCredentials:d.withCredentials})}catch(g){v(0,g);M("SSE failed. Downgrading to fallback transport and resending");return}0<d.connectTimeout&&(d.id=setTimeout(function(){c||q()},d.connectTimeout));y.onopen=function(a){J(d);"debug"===d.logLevel&&e.atmosphere.debug("SSE successfully opened");d.enableProtocol?d.isReopen&&(d.isReopen=!1,n("re-opening",d.transport,d)):c?n("re-opening","sse",d):n("opening","sse",d);c=!0;"POST"===
d.method&&(f.state="messageReceived",y.send(d.data))};y.onmessage=function(a){J(d);d.enableXDR||a.origin===window.location.protocol+"//"+window.location.host?(f.state="messageReceived",f.status=200,a=a.data,F(a,d,f)||(x(),f.responseBody="",f.messages=[])):e.atmosphere.log(d.logLevel,["Origin was not "+window.location.protocol+"//"+window.location.host])};y.onerror=function(a){clearTimeout(d.id);d.heartbeatTimer&&clearTimeout(d.heartbeatTimer);f.closedByClientTimeout||((T(c),q(),G)?e.atmosphere.log(d.logLevel,
["SSE closed normally"]):c?d.reconnect&&"sse"===f.transport&&(A++<d.maxReconnectOnClose?(n("re-connecting",d.transport,d),0<d.reconnectInterval?d.reconnectId=setTimeout(function(){t(!0)},d.reconnectInterval):t(!0),f.responseBody="",f.messages=[]):(e.atmosphere.log(d.logLevel,["SSE reconnect maximum try reached "+A]),v(0,"maxReconnectOnClose reached"))):M("SSE failed. Downgrading to fallback transport and resending"))}}}function m(c){f.transport="websocket";if(d.enableProtocol&&c){var a=e.now()-d.ctime;
d.lastTimestamp=Number(d.stime)+Number(a)}a=N(d.url);"debug"===d.logLevel&&(e.atmosphere.debug("Invoking executeWebSocket"),e.atmosphere.debug("Using URL: "+a));if(c&&!d.reconnect)null!=p&&q();else if(p=sa(a),null!=d.webSocketBinaryType&&(p.binaryType=d.webSocketBinaryType),0<d.connectTimeout&&(d.id=setTimeout(function(){if(!c){p.onclose({code:1002,reason:"",wasClean:!1});try{q()}catch(a){}}},d.connectTimeout)),p.onopen=function(a){J(d);"debug"===d.logLevel&&e.atmosphere.debug("Websocket successfully opened");
a=c;null!=p&&(p.canSendMessage=!0);d.enableProtocol||(c=!0,a?n("re-opening","websocket",d):n("opening","websocket",d));null!=p&&"POST"===d.method&&(f.state="messageReceived",p.send(d.data))},p.onmessage=function(a){J(d);d.enableProtocol&&(c=!0);f.state="messageReceived";f.status=200;a=a.data;"string"===typeof a?F(a,d,f)||(x(),f.responseBody="",f.messages=[]):(a=ia(d,a),""!==a&&(f.responseBody=a,x(),f.responseBody=null))},p.onerror=function(a){clearTimeout(d.id);d.heartbeatTimer&&clearTimeout(d.heartbeatTimer)},
p.onclose=function(a){if("closed"!==f.state){clearTimeout(d.id);var g=a.reason;if(""===g)switch(a.code){case 1E3:g="Normal closure; the connection successfully completed whatever purpose for which it was created.";break;case 1001:g="The endpoint is going away, either because of a server failure or because the browser is navigating away from the page that opened the connection.";break;case 1002:g="The endpoint is terminating the connection due to a protocol error.";break;case 1003:g="The connection is being terminated because the endpoint received data of a type it cannot accept (for example, a text-only endpoint received binary data).";
break;case 1004:g="The endpoint is terminating the connection because a data frame was received that is too large.";break;case 1005:g="Unknown: no status code was provided even though one was expected.";break;case 1006:g="Connection was closed abnormally (that is, with no close frame being sent)."}"warn"===d.logLevel&&(e.atmosphere.warn("Websocket closed, reason: "+g),e.atmosphere.warn("Websocket closed, wasClean: "+a.wasClean));f.closedByClientTimeout||((T(c),f.state="closed",G)?e.atmosphere.log(d.logLevel,
["Websocket closed normally"]):c?d.reconnect&&"websocket"===f.transport&&1001!==a.code&&(q(),A++<d.maxReconnectOnClose?(n("re-connecting",d.transport,d),0<d.reconnectInterval?d.reconnectId=setTimeout(function(){f.responseBody="";f.messages=[];m(!0)},d.reconnectInterval):(f.responseBody="",f.messages=[],m(!0))):(e.atmosphere.log(d.logLevel,["Websocket reconnect maximum try reached "+d.requestCount]),"warn"===d.logLevel&&e.atmosphere.warn("Websocket error, reason: "+a.reason),v(0,"maxReconnectOnClose reached"))):
M("Websocket failed. Downgrading to Comet and resending"))}},-1<navigator.userAgent.toLowerCase().indexOf("android")&&void 0===p.url)p.onclose({reason:"Android 4.1 does not support websockets.",wasClean:!1})}function ia(c,a){var f=a;if("polling"===c.transport)return f;if(0!==e.trim(a).length&&c.enableProtocol&&c.firstMessage){var g=c.trackMessageLength?1:0,h=a.split(c.messageDelimiter);if(h.length<=g+1)return f;c.firstMessage=!1;c.uuid=e.trim(h[g]);c.stime=e.trim(h[g+1]);h.length<=g+3&&e.atmosphere.log("error",
["Protocol data not sent by the server. If you enable protocol on client side, be sure to install JavascriptProtocol interceptor on server side.Also note that atmosphere-runtime 2.2+ should be used."]);var k=parseInt(e.trim(h[g+2]),10),l=h[g+3];if(!isNaN(k)&&0<k){var m=function(){Q(l);c.heartbeatTimer=setTimeout(m,k)};c.heartbeatTimer=setTimeout(m,k)}b=!1;"long-polling"!==c.transport&&S(c);e.atmosphere.uuid=c.uuid;f="";g=c.trackMessageLength?5:4;if(h.length>g+1)for(;g<h.length;g++)f+=h[g],g+1!==h.length&&
(f+=c.messageDelimiter);0!==c.ackInterval&&setTimeout(function(){Q("...ACK...")},c.ackInterval)}else c.enableProtocol&&c.firstMessage&&e.browser.msie&&10>+e.browser.version.split(".")[0]?e.atmosphere.log(d.logLevel,["Receiving unexpected data from IE"]):S(c);return f}function J(c){clearTimeout(c.id);0<c.timeout&&"polling"!==c.transport&&(c.id=setTimeout(function(){f.closedByClientTimeout=!0;f.state="closedByClient";f.responseBody="";f.status=408;f.messages=[];x();ea();q()},c.timeout))}function v(c,
a){q();clearTimeout(d.id);f.state="error";f.reasonPhrase=a;f.responseBody="";f.status=c;f.messages=[];x()}function F(c,a,d){c=ia(a,c);if(0===c.length)return!0;d.responseBody=c;if(a.trackMessageLength){c=d.partialMessage+c;for(var e=[],f=c.indexOf(a.messageDelimiter);-1!==f;){var h=c.substring(0,f),k=parseInt(h,10);if(isNaN(k))throw'message length "'+h+'" is not a number';f+=a.messageDelimiter.length;f+k>c.length?f=-1:(e.push(c.substring(f,f+k)),c=c.substring(f+k,c.length),f=c.indexOf(a.messageDelimiter))}d.partialMessage=
c;if(0!==e.length)d.responseBody=e.join(a.messageDelimiter),d.messages=e;else return d.responseBody="",d.messages=[],!0}else d.responseBody=c;return!1}function M(c){e.atmosphere.log(d.logLevel,[c]);if("undefined"!==typeof d.onTransportFailure)d.onTransportFailure(c,d);else if("undefined"!==typeof e.atmosphere.onTransportFailure)e.atmosphere.onTransportFailure(c,d);d.transport=d.fallbackTransport;c=-1===d.connectTimeout?0:d.connectTimeout;d.reconnect&&"none"!==d.transport||null==d.transport?(d.method=
d.fallbackMethod,f.transport=d.fallbackTransport,d.fallbackTransport="none",0<c?d.reconnectId=setTimeout(function(){h()},c):h()):v(500,"Unable to reconnect with fallback transport")}function K(c,a){var h=d;null!=c&&"undefined"!==typeof c&&(h=c);null==a&&(a=h.url);if(!h.attachHeadersAsQueryString||-1!==a.indexOf("X-Atmosphere-Framework"))return a;a+=-1!==a.indexOf("?")?"&":"?";a+="X-Atmosphere-tracking-id="+h.uuid;a+="&X-Atmosphere-Framework="+e.atmosphere.version;a+="&X-Atmosphere-Transport="+h.transport;
h.trackMessageLength&&(a+="&X-Atmosphere-TrackMessageSize=true");a=null!=h.lastTimestamp?a+("&X-Cache-Date="+h.lastTimestamp):a+"&X-Cache-Date=0";null!==h.heartbeat&&null!==h.heartbeat.server&&(a+="&X-Heartbeat-Server="+h.heartbeat.server);""!==h.contentType&&(a+="&Content-Type="+("websocket"===h.transport?h.contentType:encodeURIComponent(h.contentType)));h.enableProtocol&&(a+="&X-atmo-protocol=true");e.each(h.headers,function(d,k){var l=e.isFunction(k)?k.call(this,h,c,f):k;null!=l&&(a+="&"+encodeURIComponent(d)+
"="+encodeURIComponent(l))});return a}function S(c){c.isOpen?c.isReopen&&(c.isReopen=!1,n("re-opening",c.transport,c)):(c.isOpen=!0,n("opening",c.transport,c))}function W(c){var a=d;if(null!=c||"undefined"!==typeof c)a=c;a.lastIndex=0;a.readyState=0;if("jsonp"===a.transport||a.enableXDR&&e.atmosphere.checkCORSSupport())ha(a);else if("ajax"===a.transport)ra(c);else{if(e.browser.msie&&10>+e.browser.version.split(".")[0]){if("streaming"===a.transport){a.enableXDR&&window.XDomainRequest?U(a):V(a);return}if(a.enableXDR&&
window.XDomainRequest){U(a);return}}var h=function(){a.lastIndex=0;a.reconnect&&A++<a.maxReconnectOnClose?(n("re-connecting",c.transport,c),B(g,a,c.reconnectInterval)):v(0,"maxReconnectOnClose reached")};if(a.reconnect&&(-1===a.maxRequest||a.requestCount++<a.maxRequest)){var g=e.ajaxSettings.xhr();g.hasData=!1;da(g,a,!0);a.suspend&&(L=g);"polling"!==a.transport&&(f.transport=a.transport,g.onabort=function(){T(!0)},g.onerror=function(){f.error=!0;f.ffTryingReconnect=!0;try{f.status=XMLHttpRequest.status}catch(a){f.status=
500}f.status||(f.status=500);f.errorHandled||(q(),h())});g.onreadystatechange=function(){if(!G){f.error=null;var k=!1,l=!1;if("streaming"===a.transport&&2<a.readyState&&4===g.readyState)q(),h();else{a.readyState=g.readyState;"streaming"===a.transport&&3<=g.readyState?l=!0:"long-polling"===a.transport&&4===g.readyState&&(l=!0);J(d);if("polling"!==a.transport){var s=200;4===g.readyState&&(s=1E3<g.status?0:g.status);if(300<=s||0===s){f.errorHandled=!0;q();h();return}a.enableProtocol&&c.firstMessage||
2!==g.readyState||(e.browser.mozilla&&f.ffTryingReconnect?(f.ffTryingReconnect=!1,setTimeout(function(){f.ffTryingReconnect||S(a)},500)):S(a))}else 4===g.readyState&&(l=!0);if(l)if(l=g.responseText,0===e.trim(l).length&&"long-polling"===a.transport)g.hasData?g.hasData=!1:(f.errorHandled=!0,q(),h());else{g.hasData=!0;Y(g,d);if("streaming"===a.transport)if(e.browser.opera)e.atmosphere.iterate(function(){if(500!==f.status&&g.responseText.length>a.lastIndex){try{f.status=g.status,f.headers=fa(g.getAllResponseHeaders()),
Y(g,d)}catch(c){f.status=404}J(d);f.state="messageReceived";var e=g.responseText.substring(a.lastIndex);a.lastIndex=g.responseText.length;(k=F(e,a,f))||x();ja(g,a)&&ka(g,a)}else if(400<f.status)return a.lastIndex=g.responseText.length,!1},0);else{if(s=l.substring(a.lastIndex,l.length),k=F(s,a,f),a.lastIndex=l.length,k)return}else k=F(l,a,f);l=ja(g,a);try{f.status=g.status,f.headers=fa(g.getAllResponseHeaders()),Y(g,a)}catch(m){f.status=404}f.state=a.suspend?0===f.status?"closed":"messageReceived":
"messagePublished";(s=!l&&"streaming"!==c.transport&&"polling"!==c.transport)&&!a.executeCallbackBeforeReconnect&&B(g,a,a.pollingInterval);0===f.responseBody.length||k||x();s&&a.executeCallbackBeforeReconnect&&B(g,a,a.pollingInterval);l&&ka(g,a)}}}};g.send(a.data);aa=!0}else"debug"===a.logLevel&&e.atmosphere.log(a.logLevel,["Max re-connection reached."]),v(0,"maxRequest reached")}}function ka(c,a){O();G=!1;B(c,a,500)}function da(c,a,h){var g=a.url;null!=a.dispatchUrl&&"POST"===a.method&&(g+=a.dispatchUrl);
g=K(a,g);g=e.atmosphere.prepareURL(g);h&&(c.open(a.method,g,!0),0<a.connectTimeout&&(a.id=setTimeout(function(){0===a.requestCount&&(q(),I("Connect timeout","closed",200,a.transport))},a.connectTimeout)));d.withCredentials&&"websocket"!==d.transport&&"withCredentials"in c&&(c.withCredentials=!0);d.dropHeaders||(c.setRequestHeader("X-Atmosphere-Framework",e.atmosphere.version),c.setRequestHeader("X-Atmosphere-Transport",a.transport),null!=a.lastTimestamp?c.setRequestHeader("X-Cache-Date",a.lastTimestamp):
c.setRequestHeader("X-Cache-Date",0),null!==c.heartbeat&&null!==c.heartbeat.server&&c.setRequestHeader("X-Heartbeat-Server",c.heartbeat.server),a.trackMessageLength&&c.setRequestHeader("X-Atmosphere-TrackMessageSize","true"),c.setRequestHeader("X-Atmosphere-tracking-id",a.uuid),e.each(a.headers,function(d,g){var k=e.isFunction(g)?g.call(this,c,a,h,f):g;null!=k&&c.setRequestHeader(d,k)}));""!==a.contentType&&c.setRequestHeader("Content-Type",a.contentType)}function B(c,a,e){if(a.reconnect||a.suspend&&
aa){var g=0;1<c.readyState&&(g=1E3<c.status?0:c.status);f.status=0===g?204:g;f.reason=0===g?"Server resumed the connection or down.":"OK";clearTimeout(a.id);a.reconnectId&&(clearTimeout(a.reconnectId),delete a.reconnectId);0<e?setTimeout(function(){d.reconnectId=W(a)},e):W(a)}}function qa(c){c.state="re-connecting";la(c)}function U(c){"polling"!==c.transport?(C=ma(c),C.open()):ma(c).open()}function ma(c){var a=d;null!=c&&"undefined"!==typeof c&&(a=c);var h=a.transport,g=0,k=new window.XDomainRequest,
l=function(){"long-polling"===a.transport&&a.reconnect&&(-1===a.maxRequest||a.requestCount++<a.maxRequest)&&(k.status=200,U(a))},m=a.rewriteURL||function(a){var c=/(?:^|;\s*)(JSESSIONID|PHPSESSID)=([^;]*)/.exec(document.cookie);switch(c&&c[1]){case "JSESSIONID":return a.replace(/;jsessionid=[^\?]*|(\?)|$/,";jsessionid="+c[2]+"$1");case "PHPSESSID":return a.replace(/\?PHPSESSID=[^&]*&?|\?|$/,"?PHPSESSID="+c[2]+"&").replace(/&$/,"")}return a};k.onprogress=function(){clearTimeout(a.id);var c=k.responseText,
c=c.substring(g);g+=c.length;if("polling"!==h){J(a);var d=F(c,a,f);if("long-polling"!==h||0!==e.trim(c).length)a.executeCallbackBeforeReconnect&&l(),d||I(f.responseBody,"messageReceived",200,h),a.executeCallbackBeforeReconnect||l()}};k.onerror=function(){"polling"!==a.transport&&(q(),A++<a.maxReconnectOnClose?0<a.reconnectInterval?a.reconnectId=setTimeout(function(){n("re-connecting",c.transport,c);U(a)},a.reconnectInterval):(n("re-connecting",c.transport,c),U(a)):v(0,"maxReconnectOnClose reached"))};
k.onload=function(){};return{open:function(){var c=a.url;null!=a.dispatchUrl&&(c+=a.dispatchUrl);c=K(a,c);k.open(a.method,m(c));"GET"===a.method?k.send():k.send(a.data);0<a.connectTimeout&&(a.id=setTimeout(function(){0===a.requestCount&&(q(),I("Connect timeout","closed",200,a.transport))},a.connectTimeout))},close:function(){k.abort()}}}function V(c){C=ta(c);C.open()}function ta(c){var a=d;null!=c&&"undefined"!==typeof c&&(a=c);var h,g=new window.ActiveXObject("htmlfile");g.open();g.close();var k=
a.url;null!=a.dispatchUrl&&(k+=a.dispatchUrl);"polling"!==a.transport&&(f.transport=a.transport);return{open:function(){var c=g.createElement("iframe");k=K(a);""!==a.data&&(k+="&X-Atmosphere-Post-Body="+encodeURIComponent(a.data));k=e.atmosphere.prepareURL(k);c.src=k;g.body.appendChild(c);var l=c.contentDocument||c.contentWindow.document;h=e.atmosphere.iterate(function(){try{if(l.firstChild){if("complete"===l.readyState)try{e.noop(l.fileSize)}catch(c){return I("Connection Failure","error",500,a.transport),
!1}var k=l.body?l.body.lastChild:l,m=function(){var a=k.cloneNode(!0);a.appendChild(l.createTextNode("."));a=a.innerText;return a=a.substring(0,a.length-1)};if(!e.nodeName(k,"pre")){var p=l.head||l.getElementsByTagName("head")[0]||l.documentElement||l,q=l.createElement("script");q.text="document.write('<plaintext>')";p.insertBefore(q,p.firstChild);p.removeChild(q);k=l.body.lastChild}a.closed&&(a.isReopen=!0);h=e.atmosphere.iterate(function(){var c=m();if(c.length>a.lastIndex){J(d);f.status=200;f.error=
null;k.innerText="";if(F(c,a,f))return"";I(f.responseBody,"messageReceived",200,a.transport)}a.lastIndex=0;if("complete"===l.readyState)return T(!0),n("re-connecting",a.transport,a),0<a.reconnectInterval?a.reconnectId=setTimeout(function(){V(a)},a.reconnectInterval):V(a),!1},null);return!1}}catch(r){return f.error=!0,n("re-connecting",a.transport,a),A++<a.maxReconnectOnClose?0<a.reconnectInterval?a.reconnectId=setTimeout(function(){V(a)},a.reconnectInterval):V(a):v(0,"maxReconnectOnClose reached"),
g.execCommand("Stop"),g.close(),!1}})},close:function(){h&&h();g.execCommand("Stop");T(!0)}}}function Q(c){null!=w?w.send(c):null!=L||null!=y?Z(c):null!=C?d.enableXDR&&e.atmosphere.checkCORSSupport()?(c=na(c),c.reconnect=!1,ha(c)):Z(c):null!=u?Z(c):null!=p?ua(c):(v(0,"No suspended connection available"),e.atmosphere.error("No suspended connection available. Make sure atmosphere.subscribe has been called and request.onOpen invoked before invoking this method"))}function Z(c){c=na(c);W(c)}function oa(c){var a=
c;"object"===typeof a&&(a=c.data);return a}function na(c){var a=oa(c),a={connected:!1,timeout:6E4,method:"POST",url:d.url,contentType:d.contentType,headers:d.headers,reconnect:!0,callback:null,data:a,suspend:!1,maxRequest:-1,logLevel:"info",requestCount:0,withCredentials:d.withCredentials,transport:"polling",isOpen:!0,attachHeadersAsQueryString:!0,enableXDR:d.enableXDR,uuid:d.uuid,dispatchUrl:d.dispatchUrl,enableProtocol:!1,messageDelimiter:"|",trackMessageLength:d.trackMessageLength,maxReconnectOnClose:d.maxReconnectOnClose,
heartbeatTimer:d.heartbeatTimer,heartbeat:d.heartbeat};"object"===typeof c&&(a=e.extend(a,c));return a}function ua(c){var a=e.atmosphere.isBinary(c)?c:oa(c),f;try{f=null!=d.dispatchUrl?d.webSocketPathDelimiter+d.dispatchUrl+d.webSocketPathDelimiter+a:a,p.canSendMessage?p.send(f):e.atmosphere.error("WebSocket not connected.")}catch(g){p.onclose=function(a){},q(),M("Websocket failed. Downgrading to Comet and resending "+c),Z(c)}}function ga(c){c=e.parseJSON(c);if(c.id!==H)if("undefined"!==typeof d.onLocalMessage)d.onLocalMessage(c.event);
else if("undefined"!==typeof e.atmosphere.onLocalMessage)e.atmosphere.onLocalMessage(c.event)}function I(c,a,d,e){f.responseBody=c;f.transport=e;f.status=d;f.state=a;x()}function Y(c,a){if(a.readResponsesHeaders)try{var d=c.getResponseHeader("X-Cache-Date");d&&null!=d&&0<d.length&&(a.lastTimestamp=d.split(" ").pop());var f=c.getResponseHeader("X-Atmosphere-tracking-id");f&&null!=f&&(a.uuid=f.split(" ").pop())}catch(h){}else a.enableProtocol||(a.lastTimestamp=e.now(),a.uuid=e.atmosphere.guid())}function la(c){pa(c,
d);pa(c,e.atmosphere)}function pa(c,a){switch(c.state){case "messageReceived":A=0;if("undefined"!==typeof a.onMessage)a.onMessage(c);break;case "error":if("undefined"!==typeof a.onError)a.onError(c);break;case "opening":delete d.closed;if("undefined"!==typeof a.onOpen)a.onOpen(c);break;case "messagePublished":if("undefined"!==typeof a.onMessagePublished)a.onMessagePublished(c);break;case "re-connecting":if("undefined"!==typeof a.onReconnect)a.onReconnect(d,c);break;case "closedByClient":if("undefined"!==
typeof a.onClientTimeout)a.onClientTimeout(d);break;case "re-opening":delete d.closed;if("undefined"!==typeof a.onReopen)a.onReopen(d,c);break;case "fail-to-reconnect":if("undefined"!==typeof a.onFailureToReconnect)a.onFailureToReconnect(d,c);break;case "unsubscribe":case "closed":if(("undefined"===typeof d.closed||!d.closed)&&"undefined"!==typeof a.onClose)a.onClose(c);d.closed=!0}}function T(c){"closed"!==f.state&&(f.state="closed",f.responseBody="",f.messages=[],f.status=c?200:501,x())}function x(){var c=
function(a,c){c(f)};null==w&&null!=R&&R(f.responseBody);d.reconnect=d.mrequest;for(var a="string"===typeof f.responseBody,h=a&&d.trackMessageLength?0<f.messages.length?f.messages:[""]:Array(f.responseBody),g=0;g<h.length;g++)if(!(1<h.length&&0===h[g].length)&&(f.responseBody=a?e.trim(h[g]):h[g],null==w&&null!=R&&R(f.responseBody),0!==f.responseBody.length||"messageReceived"!==f.state)){la(f);if(0<e.atmosphere.callbacks.length){"debug"===d.logLevel&&e.atmosphere.debug("Invoking "+e.atmosphere.callbacks.length+
" global callbacks: "+f.state);try{e.each(e.atmosphere.callbacks,c)}catch(k){e.atmosphere.log(d.logLevel,["Callback exception"+k])}}if("function"===typeof d.callback){"debug"===d.logLevel&&e.atmosphere.debug("Invoking request callbacks");try{d.callback(f)}catch(l){e.atmosphere.log(d.logLevel,["Callback exception"+l])}}}}function ja(c,a){return""===f.partialMessage&&"streaming"===a.transport&&c.responseText.length>a.maxStreamingLength?!0:!1}function ea(){if(d.enableProtocol&&!d.firstMessage){var c=
"X-Atmosphere-Transport=close&X-Atmosphere-tracking-id="+d.uuid;e.each(d.headers,function(a,g){var h=e.isFunction(g)?g.call(this,d,d,f):g;null!=h&&(c+="&"+encodeURIComponent(a)+"="+encodeURIComponent(h))});var a=d.url.replace(/([?&])_=[^&]*/,c),a=a+(a===d.url?(/\?/.test(d.url)?"&":"?")+c:"");0<d.connectTimeout?e.ajax({url:a,async:!1,timeout:d.connectTimeout,cache:!1}):e.ajax({url:a,async:!1,cache:!1})}}function O(){d.reconnectId&&(clearTimeout(d.reconnectId),delete d.reconnectId);d.heartbeatTimer&&
clearTimeout(d.heartbeatTimer);d.reconnect=!1;G=!0;f.request=d;f.state="unsubscribe";f.responseBody="";f.status=408;x();ea();q()}function q(){f.partialMessage="";d.id&&clearTimeout(d.id);d.heartbeatTimer&&clearTimeout(d.heartbeatTimer);null!=C&&(C.close(),C=null);null!=u&&(u.abort(),u=null);null!=L&&(L.abort(),L=null);null!=p&&(p.canSendMessage&&p.close(),p=null);null!=y&&(y.close(),y=null);null!=E&&(clearInterval(X),document.cookie=ca+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/",E.signal("close",
{reason:"",heir:G?(E.get("children")||[])[0]:H}),E.close());null!=w&&w.close()}var d={timeout:3E5,method:"GET",headers:{},contentType:"",callback:null,url:"",data:"",suspend:!0,maxRequest:-1,reconnect:!0,maxStreamingLength:1E7,lastIndex:0,logLevel:"info",requestCount:0,fallbackMethod:"GET",fallbackTransport:"streaming",transport:"long-polling",webSocketImpl:null,webSocketBinaryType:null,dispatchUrl:null,webSocketPathDelimiter:"@@",enableXDR:!1,rewriteURL:!1,attachHeadersAsQueryString:!0,executeCallbackBeforeReconnect:!1,
readyState:0,lastTimestamp:0,withCredentials:!1,trackMessageLength:!1,messageDelimiter:"|",connectTimeout:-1,reconnectInterval:0,dropHeaders:!0,uuid:0,shared:!1,readResponsesHeaders:!1,maxReconnectOnClose:5,enableProtocol:!0,pollingInterval:0,heartbeat:{client:null,server:null},ackInterval:0,onError:function(c){},onClose:function(c){},onOpen:function(c){},onMessage:function(c){},onReopen:function(c,a){},onReconnect:function(c,a){},onMessagePublished:function(c){},onTransportFailure:function(c,a){},
onLocalMessage:function(c){},onFailureToReconnect:function(c,a){},onClientTimeout:function(c){}},f={status:200,reasonPhrase:"OK",responseBody:"",messages:[],headers:[],state:"messageReceived",transport:"polling",error:null,request:null,partialMessage:"",errorHandled:!1,closedByClientTimeout:!1,ffTryingReconnect:!1},p=null,y=null,L=null,C=null,u=null,aa=!0,A=0,G=!1,R=null,E,w=null,H=e.now(),X,ca;l(k);this.subscribe=function(c){l(c);h()};this.execute=function(){h()};this.invokeCallback=function(){x()};
this.close=function(){O()};this.disconnect=function(){ea()};this.getUrl=function(){return d.url};this.push=function(c,a){if(null!=a){var e=d.dispatchUrl;d.dispatchUrl=a;Q(c);d.dispatchUrl=e}else Q(c)};this.getUUID=function(){return d.uuid};this.pushLocal=function(c){if(0!==c.length)try{w?w.localSend(c):E&&E.signal("localMessage",e.stringifyJSON({id:H,event:c}))}catch(a){e.atmosphere.error(a)}};this.enableProtocol=function(c){return d.enableProtocol};this.request=d;this.response=f},subscribe:function(k,
l,h){"function"===typeof l&&e.atmosphere.addCallback(l);"string"!==typeof k?h=k:h.url=k;e.atmosphere.uuid="undefined"!==typeof h&&"undefined"!==typeof h.uuid?h.uuid:0;k=new e.atmosphere.AtmosphereRequest(h);k.execute();return e.atmosphere.requests[e.atmosphere.requests.length]=k},addCallback:function(k){-1===e.inArray(k,e.atmosphere.callbacks)&&e.atmosphere.callbacks.push(k)},removeCallback:function(k){k=e.inArray(k,e.atmosphere.callbacks);-1!==k&&e.atmosphere.callbacks.splice(k,1)},unsubscribe:function(){if(0<
e.atmosphere.requests.length)for(var k=[].concat(e.atmosphere.requests),l=0;l<k.length;l++){var h=k[l];h.close();clearTimeout(h.response.request.id);h.heartbeatTimer&&clearTimeout(h.heartbeatTimer)}e.atmosphere.requests=[];e.atmosphere.callbacks=[]},unsubscribeUrl:function(k){var l=-1;if(0<e.atmosphere.requests.length)for(var h=0;h<e.atmosphere.requests.length;h++){var r=e.atmosphere.requests[h];if(r.getUrl()===k){r.close();clearTimeout(r.response.request.id);r.heartbeatTimer&&clearTimeout(r.heartbeatTimer);
l=h;break}}0<=l&&e.atmosphere.requests.splice(l,1)},publish:function(k){"function"===typeof k.callback&&e.atmosphere.addCallback(k.callback);k.transport="polling";k=new e.atmosphere.AtmosphereRequest(k);return e.atmosphere.requests[e.atmosphere.requests.length]=k},checkCORSSupport:function(){return e.browser.msie&&!window.XDomainRequest&&11>+e.browser.version.split(".")[0]||e.browser.opera&&12>+e.browser.version.split(".")[0]||"KreaTVWebKit/531"===e.trim(navigator.userAgent).slice(0,16)||"kreatel"===
e.trim(navigator.userAgent).slice(-7).toLowerCase()?!0:-1<navigator.userAgent.toLowerCase().indexOf("android")?!0:!1},S4:function(){return(65536*(1+Math.random())|0).toString(16).substring(1)},guid:function(){return e.atmosphere.S4()+e.atmosphere.S4()+"-"+e.atmosphere.S4()+"-"+e.atmosphere.S4()+"-"+e.atmosphere.S4()+"-"+e.atmosphere.S4()+e.atmosphere.S4()+e.atmosphere.S4()},prepareURL:function(k){var l=e.now(),h=k.replace(/([?&])_=[^&]*/,"$1_="+l);return h+(h===k?(/\?/.test(k)?"&":"?")+"_="+l:"")},
param:function(k){return e.param(k,e.ajaxSettings.traditional)},supportStorage:function(){var k=window.localStorage;if(k)try{return k.setItem("t","t"),k.removeItem("t"),window.StorageEvent&&!e.browser.msie&&!(e.browser.mozilla&&"1"===e.browser.version.split(".")[0])}catch(l){}return!1},iterate:function(e,l){var h;l=l||0;(function P(){h=setTimeout(function(){!1!==e()&&P()},l)})();return function(){clearTimeout(h)}},log:function(e,l){if(window.console){var h=window.console[e];"function"===typeof h&&
h.apply(window.console,l)}},warn:function(){e.atmosphere.log("warn",arguments)},info:function(){e.atmosphere.log("info",arguments)},debug:function(){e.atmosphere.log("debug",arguments)},error:function(){e.atmosphere.log("error",arguments)},isBinary:function(e){return/^\[object\s(?:Blob|ArrayBuffer|.+Array)\]$/.test(Object.prototype.toString.call(e))}};(function(){var k,l;e.uaMatch=function(e){e=e.toLowerCase();e=/(chrome)[ \/]([\w.]+)/.exec(e)||/(webkit)[ \/]([\w.]+)/.exec(e)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(e)||
/(msie) ([\w.]+)/.exec(e)||/(trident)(?:.*? rv:([\w.]+)|)/.exec(e)||0>e.indexOf("compatible")&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(e)||[];return{browser:e[1]||"",version:e[2]||"0"}};k=e.uaMatch(navigator.userAgent);l={};k.browser&&(l[k.browser]=!0,l.version=k.version);l.chrome?l.webkit=!0:l.webkit&&(l.safari=!0);l.trident&&(l.msie=!0);e.browser=l;e.sub=function(){function h(e,k){return new h.fn.init(e,k)}e.extend(!0,h,this);h.superclass=this;h.fn=h.prototype=this();h.fn.constructor=h;h.sub=this.sub;
h.fn.init=function(l,n){n&&n instanceof e&&!(n instanceof h)&&(n=h(n));return e.fn.init.call(this,l,n,k)};h.fn.init.prototype=h.fn;var k=h(document);return h}})();(function(e){function l(e){return'"'+e.replace(P,function(e){var h=n[e];return"string"===typeof h?h:"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})+'"'}function h(e){return 10>e?"0"+e:e}function r(e,k){var n,N,t,m=k[e];t=typeof m;m&&"object"===typeof m&&"function"===typeof m.toJSON&&(m=m.toJSON(e),t=typeof m);switch(t){case "string":return l(m);
case "number":return isFinite(m)?String(m):"null";case "boolean":return String(m);case "object":if(!m)return"null";switch(Object.prototype.toString.call(m)){case "[object Date]":return isFinite(m.valueOf())?'"'+m.getUTCFullYear()+"-"+h(m.getUTCMonth()+1)+"-"+h(m.getUTCDate())+"T"+h(m.getUTCHours())+":"+h(m.getUTCMinutes())+":"+h(m.getUTCSeconds())+'Z"':"null";case "[object Array]":N=m.length;t=[];for(n=0;n<N;n++)t.push(r(n,m)||"null");return"["+t.join(",")+"]";default:t=[];for(n in m)Object.prototype.hasOwnProperty.call(m,
n)&&(N=r(n,m))&&t.push(l(n)+":"+N);return"{"+t.join(",")+"}"}}}var P=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,n={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};e.stringifyJSON=function(e){return window.JSON&&window.JSON.stringify?window.JSON.stringify(e):r("",{"":e})}})(e)});